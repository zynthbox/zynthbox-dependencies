#!/usr/bin/make -f
# See debhelper(7) (uncomment to enable)
# output every command that modifies files on the build system.
#export DH_VERBOSE = 1

DEB_HOST_ARCH = $(shell dpkg-architecture -qDEB_HOST_ARCH)

FLAGS  = -O3 -ffast-math -fPIC -DPIC -fvisibility=hidden -fdata-sections -ffunction-sections -DNDEBUG
ifeq ($(DEB_HOST_ARCH),armhf)
FLAGS += -march=armv7ve -mcpu=cortex-a7 -mfloat-abi=hard -mfpu=neon-vfpv4
else ifeq ($(DEB_HOST_ARCH),arm64)
FLAGS += -march=armv8-a -mcpu=cortex-a53
endif

export CFLAGS=$(FLAGS)
export CXXFLAGS=$(FLAGS) -fvisibility-inlines-hidden
export CPPFLAGS=
# export LDFLAGS=-Wl,-O1 -Wl,--as-needed -Wl,--no-undefined -Wl,--gc-sections -Wl,--strip-all -lm

%:
	dh $@

override_dh_auto_build:
	dh_auto_build -- \
		PREFIX=/usr

override_dh_auto_install:
	dh_auto_install -- \
		PREFIX=/usr \
		DESTDIR=$(CURDIR)/debian/setbfree

	mkdir -p $(CURDIR)/debian/setbfree/usr/lib/vst/

	cp /opt/kxstudio/lib/lv2vst.so $(CURDIR)/debian/setbfree/usr/lib/vst/b_synth.lv2.so
	echo "/usr/lib/lv2/b_synth/" > $(CURDIR)/debian/setbfree/usr/lib/vst/b_synth.lv2.bundle

	cp /opt/kxstudio/lib/lv2vst.so $(CURDIR)/debian/setbfree/usr/lib/vst/b_whirl.lv2.so
	echo "/usr/lib/lv2/b_whirl/" > $(CURDIR)/debian/setbfree/usr/lib/vst/b_whirl.lv2.bundle

override_dh_auto_clean:
	dh_auto_clean
	rm -f b_whirl/b_whirl.ttl
	
override_dh_usrlocal:
